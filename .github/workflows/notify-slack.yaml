name: Check New Tag Change

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - overlays/**/kustomization.yaml

jobs:
  check_new_tag:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Check if newTag is changed
      run: |
        # Fetch latest changes to ensure accurate comparison
        git fetch --prune

        # Get the hashes of the last two commits
        LAST_COMMIT=$(git rev-parse HEAD)
        PREVIOUS_COMMIT=$(git rev-parse HEAD^)

        # Check if the file ./overlays/dev1/service1/customization.yaml was changed
        if git diff --name-only $PREVIOUS_COMMIT $LAST_COMMIT | grep -q './overlays/dev1/service1/customization.yaml'; then
            # Check if the property newTag was changed
            if git diff $PREVIOUS_COMMIT $LAST_COMMIT -- ./overlays/dev1/service1/customization.yaml | grep -q '^\+.*newTag'; then
                echo "The property 'newTag' in customization.yaml was changed."
            else
                echo "The file was changed but the property 'newTag' was not modified."
            fi
        else
            echo "The file ./overlays/dev1/service1/customization.yaml was not changed."
        fi
